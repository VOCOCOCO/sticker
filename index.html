<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Turbo Gifts — stickers, TON balance & Stars</title>

<!-- Telegram Web Apps SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- lottie-web (.json) -->
<script src="https://cdn.jsdelivr.net/npm/lottie-web@5.12.2/build/player/lottie.min.js"></script>
<!-- rlottie (.tgs) -->
<script src="https://cdn.jsdelivr.net/npm/rlottie@2.6.0/dist/rlottie.min.js"></script>
<!-- GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<!-- TON Connect UI -->
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

<style>
:root{
  --bg:#0f1116;
  --bg-soft:#151822;
  --card-bg:#1a1e2a;
  --text:#ffffff;
  --muted:#c8cdd6;
  --accent-blue-start:#3abefc;
  --accent-blue-end:#6aa8ff;
  --gold:#FFD14B;
  --radius:18px;
  --card-footer-h:56px;
  --tab-size:46px;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --ton:#27A6E5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui,-apple-system,"Segoe UI",Roboto,Inter,"SF Pro",Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  line-height:1.35;
}
.app{ max-width:560px; margin:0 auto; min-height:100vh; padding-bottom:calc(var(--tab-size) + 28px); }

/* Topbar */
.topbar{
  position:sticky; top:0; z-index:40; padding:6px 12px;
  background:linear-gradient(180deg, rgba(15,17,22,.98), rgba(15,17,22,.92) 70%, rgba(15,17,22,0));
  border-bottom:1px solid rgba(255,255,255,.04); backdrop-filter:blur(6px);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.profile{ display:flex; align-items:center; gap:8px; min-width:0; }
.avatar{ width:40px; height:40px; border-radius:50%; background:#222 center/cover; border:2px solid #303544; flex-shrink:0; }
.name{ font-weight:700; font-size:17px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Wallet area */
.wallet-wrap{ display:flex; align-items:center; gap:8px; position:relative; }
.connect-btn{
  display:inline-flex; align-items:center; gap:8px; border:0; cursor:pointer;
  padding:10px 14px; border-radius:14px;
  background:linear-gradient(90deg,var(--accent-blue-start),var(--accent-blue-end));
  color:#fff; font-weight:900; box-shadow:0 8px 22px rgba(32,120,255,.25);
}
.balance-pill{
  display:none; align-items:center; gap:8px; padding:8px 12px; border-radius:14px;
  background:#101522; border:1px solid #2a3347; box-shadow:0 8px 22px rgba(0,0,0,.25);
}
.balance-pill.show{ display:inline-flex; }
.balance-icon{ width:18px; height:18px; object-fit:contain; display:none; }
.ton-badge{ width:22px; height:22px; border-radius:50%; display:grid; place-items:center; background:#0f1a27; border:1px solid #203049; }
.ton-badge svg{ width:16px; height:16px; color:var(--ton); }
.balance-val{ font-weight:900; letter-spacing:.2px; }
.plus-btn{
  width:26px; height:26px; display:grid; place-items:center; border-radius:10px; background:#2a3347; border:1px solid #39445b; cursor:pointer;
  font-weight:900; font-size:18px; line-height:1; color:#dfe7ff;
}
.wallet-caret{ width:16px; height:16px; opacity:.85; cursor:pointer; }
.wallet-menu{
  position:absolute; right:0; top:56px; z-index:55; display:none; opacity:0; transform:translateY(-8px);
  background:#121622; border:1px solid #252b3d; border-radius:12px; padding:6px; min-width:200px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}
.wallet-menu.open{ display:block; }
.wallet-menu button{ width:100%; background:transparent; border:0; color:#eaeefc; text-align:left; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
.wallet-menu button:hover{ background:#1a2030; }

/* Banner */
.banner{ margin:12px 14px; padding:13px 12px; border-radius:14px; background:linear-gradient(90deg,var(--accent-blue-start),var(--accent-blue-end)); display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow); }
.banner .title{ font-weight:800; font-size:15px; margin:0 8px; }
.banner .btn{ background:#fff; color:#09b5ff; font-weight:700; padding:6px 10px; border-radius:12px; text-decoration:none; font-size:13px; display:inline-flex; align-items:center; gap:8px; }

/* Toggle (hide sold) */
.toggle{ margin:10px 14px 0; padding:12px 14px; background:var(--bg-soft); border:1px solid #222838; border-radius:16px; display:flex; align-items:center; gap:12px; }
.toggle input{ appearance:none; width:22px; height:22px; border-radius:6px; border:2px solid #556079; display:grid; place-items:center; background:#0f1116; }
.toggle input:checked{ background:#1f283b; border-color:#6aa8ff; }
.toggle input:checked::after{ content:"✓"; color:#a8c9ff; font-size:14px; line-height:1; }
.toggle label{ color:var(--text); font-weight:600; user-select:none; }

/* Grid (market) */
.grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:14px; padding:14px; justify-items:center; align-items:start; }
.card{ position:relative; overflow:hidden; border-radius:16px; background: radial-gradient(120% 120% at 0% 0%, #20263a 0%, #1a1f2d 40%, #161b28 100%); border:1px solid #262c41; width:100%; max-width:260px; height:260px; display:flex; flex-direction:column; justify-content:flex-end; box-shadow:var(--shadow); transition:transform .12s ease; cursor:pointer;}
@media (max-width:420px){ .card{ height:200px; } }
.card:active{ transform:translateY(1px); }
.card .media{ position:absolute; left:0; right:0; top:0; height:calc(100% - var(--card-footer-h)); display:flex; align-items:center; justify-content:center; padding:14px; }
.media canvas, .media svg, .media img, .media div{ max-width:100%; max-height:100%; }
.card .footer{ height:var(--card-footer-h); display:flex; align-items:center; justify-content:center; padding:10px 14px; background:linear-gradient(180deg, rgba(11,13,18,.35), rgba(11,13,18,.55)); border-top:1px solid rgba(255,255,255,.03); backdrop-filter:blur(4px); }
.card .footer .price{ display:inline-flex; align-items:center; gap:8px; background:linear-gradient(180deg, rgba(255,210,75,.14), rgba(255,195,45,.14)); padding:6px 13px; border-radius:16px; color:#51ff00d2; font-weight:700; font-size:15px; box-shadow:0 6px 16px rgba(0,0,0,.22); }
.price-icon{ width:16px; height:16px; object-fit:contain; border-radius:3px; }
.ribbon{ position:absolute; top:10px; right:-22px; width:120px; height:26px; display:flex; align-items:center; justify-content:center; transform:rotate(35deg); background:linear-gradient(90deg,#66c2ff,#3aa6ff); color:#fff; font-weight:700; font-size:12px; border-radius:6px; box-shadow:0 4px 8px rgba(0,0,0,.25); pointer-events:none; line-height:1; padding:0 8px; white-space:nowrap; }

/* Tabbar */
.tabbar{ position:fixed; left:0; right:0; bottom:0; z-index:60; display:flex; justify-content:center; align-items:center; padding:8px 10px; background:linear-gradient(0deg, rgba(15,17,22,1), rgba(15,17,22,.96)); border-top:1px solid rgba(255,255,255,.03); }
.tabs{ width:min(560px,100%); display:flex; gap:12px; justify-content:center; }
.tab{ width:var(--tab-size); height:var(--tab-size); border-radius:12px; background:#111523; border:1px solid #252b3d; display:grid; place-items:center; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.25); transition:transform .12s, opacity .2s; overflow:hidden; }
.tab img{ width:20px; height:20px; object-fit:contain; display:block; }
.tab.active{ outline:2px solid #3f69ff55; transform:translateY(-2px); }
.tab.disabled{ opacity:.4; pointer-events:none; }

/* Fullscreen item modal */
.overlay{ position:fixed; inset:0; z-index:2000; display:none; align-items:center; justify-content:center; background:rgba(6,8,10,.95); backdrop-filter:blur(6px); }
.overlay.open{ display:flex; }
.modal-card{ width:100%; height:100%; max-height:100vh; background:linear-gradient(180deg,#0f1116,#0b0d10); border-radius:0; display:flex; flex-direction:column; overflow:hidden; padding-bottom:16px; }
.modal-top{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.03); }
.modal-title{ font-weight:800; font-size:20px; }
.modal-close{ background:transparent; border:0; color:var(--muted); font-weight:700; cursor:pointer; font-size:16px; }
.modal-body{ flex:1; display:flex; align-items:center; justify-content:center; padding:8px; overflow:auto; }
.modal-media-wrap{ width:95%; max-width:520px; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border-radius:14px; background:linear-gradient(180deg, rgba(20,22,28,.45), rgba(8,9,12,.35)); border:1px solid rgba(255,255,255,.03); box-shadow:0 20px 60px rgba(0,0,0,.6); overflow:hidden; }
.modal-media{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:8px; }
.modal-bottom{ padding:18px 16px; display:flex; flex-direction:column; gap:10px; }
.price-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.price-pill{ display:inline-flex; align-items:center; gap:10px; background:linear-gradient(180deg, rgba(255,210,75,.14), rgba(255,195,45,.14)); color:#51ff00d2; padding:10px 14px; border-radius:16px; font-weight:650; font-size:17px; box-shadow:0 8px 20px rgba(0,0,0,.35); }
.btn-ghost{ background:rgba(255,255,255,.06); color:#fff; padding:14px; border-radius:12px; text-align:center; border:1px solid rgba(255,255,255,.03); font-weight:800; text-decoration:none; }
.btn-primary{ background:linear-gradient(90deg,#2fa6ff,#1a73ff); color:#fff; padding:16px; border-radius:12px; text-align:center; font-weight:900; text-decoration:none; }
.modal-actions{ display:flex; gap:12px; flex-direction:column; }

/* Pay in TON toggle (only inside item modal) */
.payton-row{ display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-top:4px; }
.payton-label{ color:#9aa3b2; font-weight:700; }
.switch{ position:relative; width:52px; height:30px; border-radius:999px; background:#233045; border:1px solid #34415a; cursor:pointer; transition:.25s; }
.switch::after{ content:''; position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; transition:.25s; }
.switch.on{ background:#34C759; border-color:#2aa34a; }
.switch.on::after{ left:25px; }

/* Wallet sheet (Deposit+History) */
.wallet-overlay{ position:fixed; inset:0; z-index:3000; display:none; align-items:flex-end; justify-content:center; background:rgba(8,10,12,.6); backdrop-filter:blur(4px); }
.wallet-overlay.open{ display:flex; }
.wallet-modal{ width:100%; max-width:560px; background:linear-gradient(180deg,#0e1219,#0b0f16); border-top-left-radius:18px; border-top-right-radius:18px; border:1px solid #232a3b; padding:14px 14px 18px; box-shadow:0 -16px 40px rgba(0,0,0,.45); }
.wallet-header{ display:flex; align-items:center; justify-content:space-between; padding:6px 4px 10px; }
.wallet-title{ font-weight:900; font-size:20px; }
.wallet-close{ background:transparent; border:0; color:#b8c2d9; font-size:22px; cursor:pointer; }
.wallet-tabs{ display:flex; gap:8px; padding:6px 2px 12px; }
.wallet-tab{ flex:1; text-align:center; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; background:#141a26; border:1px solid #242c3e; color:#cfe0ff; }
.wallet-tab.active{ background:linear-gradient(90deg,#2fa6ff,#1a73ff); color:#fff; border-color:transparent; }
.tab-panel{ display:none; }
.tab-panel.active{ display:block; }
.form-row{ display:flex; flex-direction:column; gap:6px; padding:8px 2px; }
.input-ton{ width:100%; padding:14px 14px; border-radius:12px; border:1px solid #273149; outline:none; background:#0f1420; color:#fff; font-weight:800; font-size:18px; }
.primary-btn{ width:100%; margin-top:8px; padding:14px; border-radius:12px; border:0; cursor:pointer; font-weight:900; color:#fff; background:linear-gradient(90deg,#2fa6ff,#1a73ff); }
.small{ font-size:12px; color:#93a2bf; }
.hf-address{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#cfe0ff; letter-spacing:.2px; }

/* Inventory */
.tab3-wrapper{ padding:16px; display:none; flex-direction:column; align-items:center; gap:12px; }
.tab3-wrapper.open{ display:flex; }
.tab3-profile{ display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:6px; }
.big-avatar{ width:84px; height:84px; border-radius:50%; background:#222 center/cover; border:3px solid #303544; }
.profile-name{ font-weight:800; font-size:18px; }
.separator{ width:90%; height:1px; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); margin:4px 0 8px; border-radius:2px; }
.purchased-grid{ width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:10px; padding:0 10px 30px; box-sizing:border-box; }
.purchased-card{ position:relative; overflow:hidden; border-radius:14px; background: radial-gradient(120% 120% at 0% 0%, #1f2535 0%, #161a26 40%, #0f1116 100%); border:1px solid #232734; width:100%; max-width:220px; height:220px; display:flex; flex-direction:column; justify-content:flex-end; box-shadow:0 10px 28px rgba(0,0,0,.4); transition:transform .12s; cursor:pointer; }
.purchased-card .media{ position:absolute; left:0; right:0; top:0; height:calc(100% - 44px); display:flex; align-items:center; justify-content:center; padding:10px; }
.purchased-card .footer{ height:44px; display:flex; align-items:center; justify-content:center; width:100%; background:transparent; border-top:1px solid rgba(255,255,255,.02); }

.hidden{ display:none !important; }
.lottie-placeholder{ color:var(--muted); font-size:13px; text-align:center; padding:8px }
@media (max-width:420px){ .purchased-card{ height:180px; max-width:48%; }
}
</style>
</head>
<body>
  <div class="app" id="mainApp">
    <!-- Topbar -->
    <div class="topbar">
      <div class="profile">
        <div id="avatar" class="avatar" aria-hidden="true"></div>
        <div id="userName" class="name">User</div>
      </div>

      <!-- Wallet area -->
      <div class="wallet-wrap">
        <!-- Connect -->
        <button id="connectBtn" class="connect-btn" aria-label="Connect TON">
          <span class="addr">Connect TON</span>
        </button>

        <!-- Internal balance -->
        <div id="balancePill" class="balance-pill" title="Баланс мини-аппа">
          <img id="balanceIcon" class="balance-icon" alt="">
          <span class="ton-badge" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Zm3.8-14.7H8.2c-.4 0-.63.45-.39.78l3.6 4.86c.2.27.58.27.78 0l3.6-4.86c.24-.33.01-.78-.39-.78ZM12.4 17.2V12h-1.8v5.2c0 .44.36.8.8.8h.2c.44 0 .8-.36.8-.8Z" fill="currentColor"/></svg>
          </span>
          <span id="balanceValue" class="balance-val">0.00</span>
          <div id="plusBtn" class="plus-btn" role="button" aria-label="Пополнить">+</div>
          <svg id="walletCaret" class="wallet-caret" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div id="walletMenu" class="wallet-menu" role="menu" aria-hidden="true">
            <div style="padding:6px 8px; color:#94a5c7; font-size:12px">Подключён: <span id="hfAddr" class="hf-address">—</span></div>
            <button id="disconnectBtn">Отключить кошелёк</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Banner -->
    <div class="banner">
      <div class="title">Check our news!</div>
      <a id="bannerBtn" class="btn" href="https://example.com" target="_blank" rel="noopener">Open Gifts</a>
    </div>

    <!-- Toggle -->
    <div class="toggle" role="group" aria-label="Фильтр">
      <input id="hideSold" type="checkbox" />
      <label for="hideSold">Скрыть проданные подарки</label>
    </div>

    <!-- Grid (market) -->
    <div class="grid" id="cardsGrid" aria-live="polite">
      <article class="card" id="card1" data-sold="false" data-invoice-url="https://t.me/$OEtEnkq5wEppDQAAuOeA4xzWyR4" role="article" aria-label="Cute sticker — 1 из 100">
        <div class="ribbon" aria-hidden="true">1 из 100</div>
        <div class="media lottie" data-lottie-url="https://raw.githubusercontent.com/vovashmyhol/shop/refs/heads/main/sticker.json">
          <div class="lottie-placeholder">Lottie 1</div>
        </div>
        <div class="footer">
          <div class="price"><img src="stars-DBKMczxe.png" alt="icon" class="price-icon"><span class="price-value">10</span></div>
        </div>
      </article>
      <article class="card" id="card2" data-sold="false" data-invoice-url="https://t.me/$OEtEnkq5wEppDQAAuOeA4xzWyR4" role="article" aria-label="Dog sticker — 1 из 50">
        <div class="ribbon" aria-hidden="true">1 из 50</div>
        <div class="media lottie" data-lottie-url="https://raw.githubusercontent.com/vovashmyhol/shop/refs/heads/main/002_DOG%20(1).json">
          <div class="lottie-placeholder">Lottie 2</div>
        </div>
        <div class="footer">
          <div class="price"><img src="stars-DBKMczxe.png" alt="icon" class="price-icon"><span class="price-value">25</span></div>
        </div>
      </article>
    </div>
  </div>

  <!-- Tabbar -->
  <nav class="tabbar" aria-label="Навигация">
    <div class="tabs" role="tablist">
      <div class="tab active" role="tab" aria-selected="true" id="tab1" title="Маркет">
        <img src="stars-DBKMczxe.png" alt="tab1 icon">
      </div>
      <div class="tab disabled" role="tab" aria-selected="false" id="tab2" title="Неактивно">
        <img src="https://dummyimage.com/64x64/2b3345/ffffff&text=2" alt="tab2 icon">
      </div>
      <div class="tab" role="tab" aria-selected="false" id="tab3" title="Инвентарь">
        <img src="https://dummyimage.com/64x64/2b3345/ffffff&text=3" alt="tab3 icon">
      </div>
    </div>
  </nav>

  <!-- Inventory -->
  <div id="tab3Content" class="tab3-wrapper" aria-hidden="true">
    <div class="tab3-profile">
      <div id="bigAvatar" class="big-avatar" aria-hidden="true"></div>
      <div id="bigName" class="profile-name">User</div>
    </div>
    <div class="separator" aria-hidden="true"></div>
    <div id="purchasedGrid" class="purchased-grid" aria-live="polite"></div>
  </div>

  <!-- ITEM MODAL -->
  <div id="itemOverlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card" role="document" aria-label="Детали подарка">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Подарок</div>
        <button id="modalCloseBtn" class="modal-close" aria-label="Закрыть">✕</button>
      </div>

      <div class="modal-body">
        <div class="modal-media-wrap">
          <div id="modalLottie" class="modal-media"></div>
        </div>
      </div>

      <div class="modal-bottom">
        <div class="price-row">
          <div class="price-pill" id="modalPricePill">
            <img src="stars-DBKMczxe.png" alt="icon" style="width:18px;height:18px;object-fit:contain">
            <div id="modalPriceValue">15</div>
          </div>
          <div style="color:#9aa3b2;font-weight:600;margin-left:8px" id="modalShort"></div>
        </div>

        <div class="payton-row">
          <div class="payton-label">Оплата в TON</div>
          <div id="payTonSwitch" class="switch" role="switch" aria-checked="false"></div>
        </div>

        <div class="modal-actions">
          <a id="modalBuyStars" class="btn-ghost" href="#" target="_blank" rel="noopener">Купить звёзды ★</a>
          <a id="modalBuyGift" class="btn-primary" href="#" target="_blank" rel="noopener">Купить подарок — ★ <span id="modalBuyPrice">15</span></a>
        </div>
      </div>
    </div>
  </div>

  <!-- Wallet sheet -->
  <div id="walletOverlay" class="wallet-overlay" aria-hidden="true">
    <div class="wallet-modal" role="dialog" aria-modal="true">
      <div class="wallet-header">
        <div class="wallet-title">Кошелёк</div>
        <button id="walletClose" class="wallet-close" aria-label="Закрыть">×</button>
      </div>

      <div class="wallet-tabs">
        <div id="tabDeposit"  class="wallet-tab active">Пополнить</div>
        <div id="tabHistory"  class="wallet-tab">История</div>
      </div>

      <div id="panelDeposit" class="tab-panel active">
        <div class="small">Подключённый: <span id="connectedShort" class="hf-address">—</span></div>
        <div class="form-row">
          <input id="amountInput" class="input-ton" type="number" step="0.000000001" min="0" placeholder="Сумма в TON" />
          <button id="depositBtn" class="primary-btn">Пополнить</button>
          <div class="small">После подтверждения в кошельке средства зачислятся на внутренний баланс.</div>
        </div>
      </div>

      <div id="panelHistory" class="tab-panel">
        <div class="small">История мини-аппа</div>
        <div id="txList" class="tx-list"></div>
      </div>
    </div>
  </div>

<script>
/* ===== SETTINGS ===== */
const MERCHANT_ADDRESS = 'UQDyKNQLN_PqZgd_NXnVe80cezX9M5mCL0izNW3w2iQAXkp0';
const TONCENTER_API    = 'https://toncenter.com/api/v2';
const TONCENTER_KEY    = '4450d174a1faa93de6c3acbc449cb55e7b60d2c83799111ae9e55ac9ad082152';
const MANIFEST_URL     = 'https://vocococo.github.io/ton-connect/tonconnect-manifest.json';
const APP_BALANCE_KEY  = 'tgifts_balance_v1';
const APP_HISTORY_KEY  = 'tgifts_history_v1';
const CREDITED_TXS_KEY = 'tgifts_credited_v1';
const BALANCE_ICON_URL = ''; // <- сюда можно вставить свою png/svg иконку; если пусто - показывается TON круг.

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
function truncate(a){ return a ? a.slice(0,4)+'…'+a.slice(-4) : ''; }
function fromNano(n){ const v = Number(n)/1e9; return (v<1? v.toFixed(4): v.toFixed(2)); }
function toNano(t){ return Math.round(Number(t)*1e9).toString(); }
function animateIn(el){ if(!el) return; if(window.gsap){ gsap.fromTo(el,{opacity:0,y:10},{opacity:1,y:0,duration:.25,ease:'power2.out'}); } }
function animateOut(el, cb){ if(!el) return cb&&cb(); if(window.gsap){ gsap.to(el,{opacity:0,y:10,duration:.2,ease:'power2.in',onComplete:cb}); } else cb&&cb(); }

/* ===== TON CONNECT UI ===== */
const tonUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: MANIFEST_URL,
  actionsConfiguration: { twaReturnUrl: 'https://t.me' } // для ретёрна в мини-апп
});

/* ===== INTERNAL BALANCE / HISTORY ===== */
function readBalance(){ return Number(localStorage.getItem(APP_BALANCE_KEY)||'0'); }
function writeBalance(v){ localStorage.setItem(APP_BALANCE_KEY, String(v)); renderBalancePill(); }
function readHistory(){ try{return JSON.parse(localStorage.getItem(APP_HISTORY_KEY)||'[]');}catch{ return []; } }
function addHistory(r){ const list=readHistory(); list.unshift(r); localStorage.setItem(APP_HISTORY_KEY, JSON.stringify(list)); renderHistory(); }
function readCredited(){ try{return JSON.parse(localStorage.getItem(CREDITED_TXS_KEY)||'[]');}catch{return [];} }
function markCredited(h){ const set = new Set(readCredited()); set.add(h); localStorage.setItem(CREDITED_TXS_KEY, JSON.stringify(Array.from(set))); }
function isCredited(h){ return new Set(readCredited()).has(h); }

/* ===== TOP RIGHT (connect/balance) ===== */
const connectBtn=$('#connectBtn');
const balancePill=$('#balancePill');
const balanceValue=$('#balanceValue');
const balanceIcon=$('#balanceIcon');
const plusBtn=$('#plusBtn');
const walletCaret=$('#walletCaret');
const walletMenu=$('#walletMenu');
const disconnectBtn=$('#disconnectBtn');
const hfAddrSpan=$('#hfAddr');

if(BALANCE_ICON_URL){
  balanceIcon.src = BALANCE_ICON_URL;
  balanceIcon.style.display='block';
} else {
  balanceIcon.style.display='none';
}

async function renderBalancePill(){
  const bal=readBalance();
  balanceValue.textContent = (bal<1? bal.toFixed(4): bal.toFixed(2));
  const addr = tonUI.account?.address;
  if(addr){
    connectBtn.style.display='none';
    balancePill.classList.add('show');
    hfAddrSpan.textContent = truncate(addr);
  }else{
    balancePill.classList.remove('show');
    connectBtn.style.display='inline-flex';
  }
}
renderBalancePill();

connectBtn.addEventListener('click', async ()=>{ try{ await tonUI.openModal(); }catch{} });
tonUI.onStatusChange(()=>{ renderBalancePill(); });

walletCaret.addEventListener('click', ()=>{
  const open = walletMenu.style.display==='block';
  if(!open){
    walletMenu.style.display='block';
    if(window.gsap) gsap.to(walletMenu,{opacity:1, y:0, duration:.25, ease:'power2.out'});
  }else{
    if(window.gsap) gsap.to(walletMenu,{opacity:0, y:-8, duration:.2, ease:'power2.in', onComplete:()=>{walletMenu.style.display='none';}});
    else walletMenu.style.display='none';
  }
});
document.addEventListener('click', (e)=>{
  if(!walletMenu.contains(e.target) && e.target!==walletCaret){ walletMenu.style.display='none'; walletMenu.style.opacity=0; }
});
disconnectBtn.addEventListener('click', async ()=>{ try{ await tonUI.disconnect(); }catch{}; walletMenu.style.display='none'; renderBalancePill(); });

/* ===== WALLET SHEET ===== */
const walletOverlay=$('#walletOverlay');
const walletClose=$('#walletClose');
const tabDeposit=$('#tabDeposit');
const tabHistory=$('#tabHistory');
const panelDeposit=$('#panelDeposit');
const panelHistory=$('#panelHistory');
const connectedShort=$('#connectedShort');

function setWalletTab(which){
  [tabDeposit,tabHistory].forEach(t=>t.classList.remove('active'));
  [panelDeposit,panelHistory].forEach(p=>p.classList.remove('active'));
  if(which==='deposit'){ tabDeposit.classList.add('active'); panelDeposit.classList.add('active'); animateIn(panelDeposit); }
  if(which==='history'){ tabHistory.classList.add('active'); panelHistory.classList.add('active'); renderHistory(); animateIn(panelHistory); }
}
function openWallet(which='deposit'){
  if(tonUI.connected) connectedShort.textContent = truncate(tonUI.account.address);
  setWalletTab(which);
  walletOverlay.classList.add('open'); walletOverlay.setAttribute('aria-hidden','false'); animateIn($('.wallet-modal'));
}
function closeWallet(){ animateOut($('.wallet-modal'), ()=>{ walletOverlay.classList.remove('open'); walletOverlay.setAttribute('aria-hidden','true'); }); }
plusBtn.addEventListener('click', ()=>{ if(!tonUI.connected){ tonUI.openModal(); return; } openWallet('deposit'); });
walletClose.addEventListener('click', closeWallet);
walletOverlay.addEventListener('click', (e)=>{ if(e.target===walletOverlay) closeWallet(); });
tabDeposit.addEventListener('click', ()=> setWalletTab('deposit'));
tabHistory.addEventListener('click', ()=> setWalletTab('history'));

/* ===== TonCenter helpers (polling to confirm) ===== */
async function tcGet(path, params={}){
  const url=new URL(TONCENTER_API+path);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
  const res=await fetch(url.toString(), { headers:{'X-API-Key':TONCENTER_KEY} });
  const data=await res.json();
  if(!data || data.ok===false) throw new Error('TonCenter: '+(data?.error||res.status));
  return data.result ?? data;
}
async function findOutgoingToMerchant(from, expectedNano, lookBackSec=300){
  const txs = await tcGet('/getTransactions', { address: from, limit: 20 });
  const since = Math.floor(Date.now()/1000) - lookBackSec;
  for(const tx of txs){
    const ut = Number(tx.utime || 0);
    if(ut < since) continue;
    for(const m of (tx.out_msgs||[])){
      if(m.destination === MERCHANT_ADDRESS){
        const diff = Math.abs(Number(m.value||0) - Number(expectedNano));
        if(diff < 20000){ // ~0.00002 TON допуск
          const hash = tx.transaction_id?.hash || '';
          return { found:true, hash };
        }
      }
    }
  }
  return { found:false };
}

/* ===== Deposit (real TonConnect modal) ===== */
const amountInput=$('#amountInput');
const depositBtn=$('#depositBtn');

depositBtn.addEventListener('click', async ()=>{
  if(!tonUI.connected){ await tonUI.openModal(); return; }
  const amt = Number(amountInput.value);
  if(!amt || amt<=0){ alert('Укажи сумму в TON'); return; }
  const nano = toNano(amt);

  try{
    // 1) Реальный вызов TonConnect — появится системное окно «Confirm the transaction in Tonkeeper»
    await tonUI.sendTransaction({
      validUntil: Math.floor(Date.now()/1000) + 300,
      messages: [{ address: MERCHANT_ADDRESS, amount: nano }]
    });

    // 2) После возврата — проверяем сеть и зачисляем
    const addr = tonUI.account.address;
    let ok=false, proof=null;
    const deadline = Date.now()+90000;
    while(Date.now()<deadline){
      proof = await findOutgoingToMerchant(addr, nano, 600);
      if(proof.found && !isCredited(proof.hash)){ ok=true; break; }
      await new Promise(r=>setTimeout(r, 4000));
    }
    if(ok){
      markCredited(proof.hash);
      writeBalance(readBalance()+amt);
      addHistory({ type:'deposit', amount: amt, date: Date.now(), from: truncate(addr) });
      amountInput.value='';
      setWalletTab('history');
    }else{
      alert('Транзакция не подтвердилась в сети. Обнови историю через минуту.');
    }
  }catch(e){
    // Пользователь отменил или ошибка кошелька — это из TonConnect UI
    alert('Операция отменена или ошибка');
    console.warn(e);
  }
});

/* ===== History render (internal) ===== */
const txList=$('#txList');
function renderHistory(){
  const list=readHistory();
  txList.innerHTML='';
  if(!list.length){ txList.innerHTML='<div class="small">История пуста</div>'; return; }
  for(const r of list){
    const row=document.createElement('div'); row.className='tx-item';
    const left=document.createElement('div'); left.className='left';
    const title=document.createElement('div');
    const right=document.createElement('div'); right.className='amount';
    const when=new Date(r.date||Date.now()).toLocaleString();
    const date=document.createElement('div'); date.className='date'; date.textContent=when;
    if(r.type==='deposit'){ title.textContent='Пополнение ('+(r.from||'wallet')+')'; right.textContent='+'+Number(r.amount).toFixed(4)+' TON'; }
    else if(r.type==='purchase'){ title.textContent='Покупка: '+(r.item||'gift'); right.textContent=Number(r.amount).toFixed(4)+' TON'; }
    else { title.textContent=r.type||'Операция'; right.textContent=(r.amount>0?'+':'')+Number(r.amount).toFixed(4)+' TON'; }
    left.appendChild(title); left.appendChild(date); row.appendChild(left); row.appendChild(right); txList.appendChild(row);
  }
}

/* ===== Inventory ===== */
const PURCHASE_KEY='turbo_gifts_purchased_v1';
function readPurchased(){ try{return JSON.parse(localStorage.getItem(PURCHASE_KEY)||'[]');}catch{return [];} }
function savePurchased(list){ try{ localStorage.setItem(PURCHASE_KEY, JSON.stringify(list)); }catch{} }
function addPurchased(item){ const list=readPurchased(); if(!list.some(x=>x.id===item.id)){ list.unshift(item); savePurchased(list); renderPurchasedGrid(); } }

function createPurchasedCardNode(item){
  const a=document.createElement('article'); a.className='purchased-card'; a.setAttribute('data-purchased-id',item.id);
  const media=document.createElement('div'); media.className='media'; media.setAttribute('data-lottie-url', item.lottie||'');
  const footer=document.createElement('div'); footer.className='footer';
  const priceWrap=document.createElement('div'); priceWrap.className='price'; priceWrap.style.display='inline-flex'; priceWrap.style.alignItems='center'; priceWrap.style.gap='8px'; priceWrap.style.color='#fff';
  priceWrap.innerHTML=`<img src="stars-DBKMczxe.png" alt="icon" class="price-icon" style="width:14px;height:14px"><span class="price-value">${item.price}</span>`;
  footer.appendChild(priceWrap); a.appendChild(media); a.appendChild(footer);
  const inner=document.createElement('div'); inner.style.width='100%'; inner.style.height='100%'; if(item.lottie) inner.setAttribute('data-lottie-url', item.lottie); media.appendChild(inner); loadLottieFor(inner);
  a.addEventListener('click',()=> openItemModalFromPurchased(item));
  return a;
}
function renderPurchasedGrid(){
  const grid=$('#purchasedGrid'); grid.innerHTML='';
  const list=readPurchased();
  if(!list.length){ grid.innerHTML='<div style="color:var(--muted);padding:12px;grid-column:1/-1;text-align:center">Пока нет купленных подарков</div>'; return; }
  list.forEach(item=> grid.appendChild(createPurchasedCardNode(item)));
}

/* ===== Item modal (with TON toggle; inventory -> Mint) ===== */
const itemOverlay=$('#itemOverlay');
const modalCloseBtn=$('#modalCloseBtn');
const modalTitle=$('#modalTitle');
const modalLottie=$('#modalLottie');
const modalPriceValue=$('#modalPriceValue');
const modalBuyStars=$('#modalBuyStars');
const modalBuyGift=$('#modalBuyGift');
const modalBuyPrice=$('#modalBuyPrice');
const modalShort=$('#modalShort');
const payTonSwitch=$('#payTonSwitch');

let activeItemMeta=null, lastLottieUrl=null;

function openItemModal(cardEl){
  activeItemMeta={
    id: cardEl.id || ('gift_'+Date.now()),
    title: cardEl.getAttribute('aria-label') || 'Подарок',
    priceStars: Number(cardEl.querySelector('.price .price-value')?.textContent?.trim() || '0'),
    lottie: cardEl.querySelector('.media.lottie')?.getAttribute('data-lottie-url') || '',
    invoice: cardEl.getAttribute('data-invoice-url') || '#',
    purchased:false
  };
  showItemModal(activeItemMeta);
}
function openItemModalFromPurchased(item){
  activeItemMeta={ id:item.id, title:item.title, priceStars:Number(item.price), lottie:item.lottie, invoice:item.invoice||'#', purchased:true };
  showItemModal(activeItemMeta);
}
function showItemModal(meta){
  modalTitle.textContent=meta.title;
  modalPriceValue.textContent=meta.priceStars;
  modalBuyPrice.textContent=meta.priceStars;
  modalShort.textContent='';
  modalBuyStars.href=$('#bannerBtn').href||'#';
  modalBuyGift.href=meta.invoice||'#';

  // media
  modalLottie.innerHTML='';
  if(meta.lottie){ lastLottieUrl=meta.lottie; const c=document.createElement('div'); c.style.width='100%'; c.style.height='100%'; c.setAttribute('data-lottie-url',meta.lottie); modalLottie.appendChild(c); loadLottieFor(c); }
  else { modalLottie.innerHTML='<div class="lottie-placeholder">Нет анимации</div>'; }

  // toggle default OFF
  payTonSwitch.classList.remove('on'); payTonSwitch.setAttribute('aria-checked','false');

  // Inventory UX
  if(meta.purchased){
    $('#modalBuyStars').classList.add('hidden');
    $('.payton-row').classList.add('hidden');
    modalBuyGift.textContent='Mint (скоро)'; modalBuyGift.style.opacity=.55; modalBuyGift.style.pointerEvents='none';
  }else{
    $('#modalBuyStars').classList.remove('hidden');
    $('.payton-row').classList.remove('hidden');
    modalBuyGift.textContent='Купить подарок — ★ '; const sp=document.createElement('span'); sp.id='modalBuyPrice'; sp.textContent=meta.priceStars; modalBuyGift.appendChild(sp);
    modalBuyGift.style.opacity=1; modalBuyGift.style.pointerEvents='';
  }

  itemOverlay.classList.add('open'); itemOverlay.setAttribute('aria-hidden','false'); animateIn($('.modal-card'));
}
function closeItem(){ animateOut($('.modal-card'), ()=>{ itemOverlay.classList.remove('open'); itemOverlay.setAttribute('aria-hidden','true'); }); }
modalCloseBtn.addEventListener('click', closeItem);
itemOverlay.addEventListener('click',(e)=>{ if(e.target===itemOverlay) closeItem(); });
document.querySelectorAll('.card').forEach(card=> card.addEventListener('click', ()=> openItemModal(card)));

payTonSwitch.addEventListener('click', ()=>{
  payTonSwitch.classList.toggle('on');
  const on=payTonSwitch.classList.contains('on');
  payTonSwitch.setAttribute('aria-checked', on?'true':'false');
});

modalBuyGift.addEventListener('click', async (e)=>{
  const payInTon = payTonSwitch.classList.contains('on');
  if(payInTon){
    e.preventDefault();
    const priceTON = Number(activeItemMeta.priceStars); // при TON считаем «цена» как TON
    const bal=readBalance();
    if(bal < priceTON){ alert('Недостаточно средств на внутреннем балансе'); return; }
    writeBalance(bal - priceTON);
    addHistory({ type:'purchase', amount:-priceTON, date:Date.now(), item:activeItemMeta.title });
    addPurchased({ id:activeItemMeta.id, title:activeItemMeta.title, price:activeItemMeta.priceStars, lottie:activeItemMeta.lottie, invoice:activeItemMeta.invoice });
    closeItem();
  }
});

/* ===== Lottie for cards ===== */
function loadLottieFor(el){
  const url=el.getAttribute('data-lottie-url'); el.innerHTML='';
  if(!url){ el.innerHTML='<div class="lottie-placeholder">Укажи ссылку Lottie</div>'; return; }
  if(/\.json(\?|$)/i.test(url) && window.lottie){ try{ lottie.loadAnimation({container:el, renderer:'svg', loop:true, autoplay:true, path:url}); return; }catch{} }
  if(/\.tgs(\?|$)/i.test(url) && window.rlottie){ try{ new rlottie.Player({name:'anim-'+Math.random().toString(36).slice(2), src:url, loop:true, autoplay:true, container:el}); el.style.display='grid'; el.style.placeItems='center'; return; }catch{} }
  if(/\.(svg|png|jpg|jpeg|gif)(\?|$)/i.test(url)){ const img=document.createElement('img'); img.src=url; img.alt='media'; img.style.maxWidth='100%'; img.style.maxHeight='100%'; el.appendChild(img); return; }
  el.innerHTML='<div class="lottie-placeholder">Неподдерживаемый формат</div>';
}
document.querySelectorAll('.media.lottie').forEach(loadLottieFor);

/* ===== Hide sold animation ===== */
const hideSoldCheckbox=$('#hideSold');
function soldCards(){ return Array.from(document.querySelectorAll('[data-sold="true"]')); }
function hideSoldAnimated(){ soldCards().forEach(c=>{ if(c.dataset._hidden==='1')return; if(window.gsap){ gsap.to(c,{duration:.28,opacity:0,scale:.98,y:-6,onComplete:()=>{c.style.display='none'; c.dataset._hidden='1';}})} }); }
function showSoldAnimated(){ soldCards().forEach(c=>{ if(c.dataset._hidden!=='1')return; c.style.display=''; if(window.gsap){ gsap.set(c,{opacity:0,scale:.98,y:-6}); gsap.to(c,{duration:.3,opacity:1,scale:1,y:0,onComplete:()=>{c.dataset._hidden='0';}})} }); }
hideSoldCheckbox.addEventListener('change', ()=> hideSoldCheckbox.checked ? hideSoldAnimated() : showSoldAnimated());

/* ===== Tabs animation ===== */
const tab1=$('#tab1'), tab3=$('#tab3');
const mainApp=$('#mainApp'), tab3Content=$('#tab3Content');
function openTab(id){
  [tab1,tab3].forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
  if(id==='tab3'){
    tab3.classList.add('active'); tab3.setAttribute('aria-selected','true');
    mainApp.style.display='none'; tab3Content.classList.add('open'); tab3Content.setAttribute('aria-hidden','false'); animateIn(tab3Content);
  }else{
    tab1.classList.add('active'); tab1.setAttribute('aria-selected','true');
    tab3Content.classList.remove('open'); tab3Content.setAttribute('aria-hidden','true'); mainApp.style.display=''; animateIn(mainApp);
  }
}
tab1.addEventListener('click', ()=> openTab('tab1'));
tab3.addEventListener('click', ()=> openTab('tab3'));

/* ===== Telegram user ===== */
(function initTelegramUser(){
  try{
    if(window.Telegram && Telegram.WebApp){
      Telegram.WebApp.ready();
      const u=Telegram.WebApp.initDataUnsafe?.user || null;
      if(u){
        const parts=[]; if(u.first_name)parts.push(u.first_name); if(u.last_name)parts.push(u.last_name); if(!parts.length && u.username) parts.push(u.username);
        const display=parts.join(' ')||'User';
        $('#userName').textContent=display; $('#bigName').textContent=display;
        if(u.photo_url){ $('#avatar').style.backgroundImage=`url("${u.photo_url}")`; $('#bigAvatar').style.backgroundImage=`url("${u.photo_url}")`; }
      }
    }
  }catch{}
})();

/* ===== Init ===== */
window.addEventListener('load', ()=>{ if(hideSoldCheckbox.checked) setTimeout(hideSoldAnimated,120); renderPurchasedGrid(); renderHistory(); renderBalancePill(); });
</script>
</body>
</html>
